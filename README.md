# Node Starter

A Node server folder structure with user registration.

It uses Redis for cache management and Postgres as relational database. Redis usage can be easily removed.

## Folder structure

(File tree generated by [mddir](https://www.npmjs.com/package/mddir))

```
|-- personal
    |-- .editorconfig
    |-- .env
    |-- .env.example
    |-- .eslintignore
    |-- .eslintrc.json
    |-- .gitignore
    |-- README.md
    |-- babel.config.js
    |-- jest.config.js
    |-- ormconfig.example.json
    |-- ormconfig.json
    |-- package.json
    |-- prettier.config.js
    |-- tsconfig.json
    |-- yarn.lock
    |-- src
    |   |-- @types
    |   |   |-- express.d.ts
    |   |-- config
    |   |   |-- auth.ts
    |   |   |-- cache.ts
    |   |   |-- mail.ts
    |   |   |-- upload.ts
    |   |-- modules
    |   |   |-- users
    |   |       |-- dtos
    |   |       |   |-- ICreateUserDTO.ts
    |   |       |   |-- IFindAllProvidersDTO.ts
    |   |       |-- infra
    |   |       |   |-- http
    |   |       |   |   |-- controllers
    |   |       |   |   |   |-- ForgotPasswordController.ts
    |   |       |   |   |   |-- ProfileController.ts
    |   |       |   |   |   |-- ResetPasswordController.ts
    |   |       |   |   |   |-- SessionsControllers.ts
    |   |       |   |   |   |-- UserAvatarController.ts
    |   |       |   |   |   |-- UsersControllers.ts
    |   |       |   |   |-- middlewares
    |   |       |   |   |   |-- ensureAuthenticated.ts
    |   |       |   |   |-- routes
    |   |       |   |       |-- password.routes.ts
    |   |       |   |       |-- profile.routes.ts
    |   |       |   |       |-- sessions.routes.ts
    |   |       |   |       |-- users.routes.ts
    |   |       |   |-- typeorm
    |   |       |       |-- entities
    |   |       |       |   |-- User.ts
    |   |       |       |   |-- UserToken.ts
    |   |       |       |-- repositories
    |   |       |           |-- UserTokensRepository.ts
    |   |       |           |-- UsersRepository.ts
    |   |       |-- providers
    |   |       |   |-- index.ts
    |   |       |   |-- HashProvider
    |   |       |       |-- fakes
    |   |       |       |   |-- FakeHashProvider.ts
    |   |       |       |-- implementations
    |   |       |       |   |-- BCryptHashProvider.ts
    |   |       |       |-- models
    |   |       |           |-- IHashProvider.ts
    |   |       |-- repositories
    |   |       |   |-- IUserTokensRepository.ts
    |   |       |   |-- IUsersRepository.ts
    |   |       |   |-- fakes
    |   |       |       |-- FakeUserTokensRepository.ts
    |   |       |       |-- FakeUsersRepository.ts
    |   |       |-- services
    |   |       |   |-- AuthenticateUserService.spec.ts
    |   |       |   |-- AuthenticateUserService.ts
    |   |       |   |-- CreateUserService.spec.ts
    |   |       |   |-- CreateUserService.ts
    |   |       |   |-- ResetPasswordService.spec.ts
    |   |       |   |-- ResetPasswordService.ts
    |   |       |   |-- SendForgotPasswordEmailService.spec.ts
    |   |       |   |-- SendForgotPasswordEmailService.ts
    |   |       |   |-- ShowProfileService.spec.ts
    |   |       |   |-- ShowProfileService.ts
    |   |       |   |-- UpdateProfileService.spec.ts
    |   |       |   |-- UpdateProfileService.ts
    |   |       |   |-- UpdateUserAvatarService.spec.ts
    |   |       |   |-- UpdateUserAvatarService.ts
    |   |       |-- views
    |   |           |-- forgot_password.hbs
    |   |-- shared
    |       |-- container
    |       |   |-- index.ts
    |       |   |-- providers
    |       |       |-- index.ts
    |       |       |-- CacheProvider
    |       |       |   |-- index.ts
    |       |       |   |-- dtos
    |       |       |   |-- fakes
    |       |       |   |   |-- FakeCacheProvider.ts
    |       |       |   |-- implementations
    |       |       |   |   |-- RedisCacheProvider.ts
    |       |       |   |-- models
    |       |       |       |-- ICacheProvider.ts
    |       |       |-- MailProvider
    |       |       |   |-- index.ts
    |       |       |   |-- dtos
    |       |       |   |   |-- ISendMailDTO.ts
    |       |       |   |-- fakes
    |       |       |   |   |-- FakeMailProvider.ts
    |       |       |   |-- implementations
    |       |       |   |   |-- EtherealMailProvider.ts
    |       |       |   |   |-- SESMailProvider.ts
    |       |       |   |-- models
    |       |       |       |-- IMailProvider.ts
    |       |       |-- MailTemplateProvider
    |       |       |   |-- index.ts
    |       |       |   |-- dtos
    |       |       |   |   |-- IParseMailTemplateDTO.ts
    |       |       |   |-- fakes
    |       |       |   |   |-- FakeMailTemplateProvider.ts
    |       |       |   |-- implementations
    |       |       |   |   |-- HandlebarsMailTemplateProvider.ts
    |       |       |   |-- models
    |       |       |       |-- IMailTemplateProviders.ts
    |       |       |-- StorageProvider
    |       |           |-- index.ts
    |       |           |-- fakes
    |       |           |   |-- FakeStorageProvider.ts
    |       |           |-- implementations
    |       |           |   |-- DiskStorageProvider.ts
    |       |           |   |-- S3StorageProvider.ts
    |       |           |-- models
    |       |               |-- IStorageProvider.ts
    |       |-- errors
    |       |   |-- AppError.ts
    |       |-- infra
    |           |-- http
    |           |   |-- server.ts
    |           |   |-- middlewares
    |           |   |   |-- RateLimiter.ts
    |           |   |-- routes
    |           |       |-- index.ts
    |           |-- typeorm
    |               |-- index.ts
    |               |-- migrations
    |                   |-- .gitkeep
    |                   |-- 1594933441962-CreateUsers.ts
    |                   |-- 1594935768060-CreateUserTokens.ts
    |-- tmp
        |-- .gitkeep
        |-- uploads
            |-- .gitkeep
```

See detailed information below.

The list is ordered by folder complexity: from least complex to "absolute mess".

- **ğŸ“ tmp/**

  **Do not delete the temp folder**. It's used by upload services. It doesn't have `.gitkeep` files by mistake.

  You can delete files commited by mistake but not the folders inside it.

- **ğŸ“ src/**

  Where all code is located

  - **ğŸ“ @types/**

    Custom types for typescript. Name template: `_filename_.d.ts` (the `d` stands for `definition`).

  - **ğŸ“ config/**

      Add here default configuration for the whole project. All of the files are filled through `.env`.

    - **âœï¸ auth.ts**

      JWT secret and expiration date

    - **âœï¸ cache.ts**

      Cache configuration. In this file, Redis (but I might change)

    - **âœï¸ mail.ts**

      E-mail provider configuration, defauts to Ethereal.

    - **âœï¸ upload.ts**

      Configs upload folder with `multer` and AWS bucket

  - **ğŸ“ shared/**

    Files shared by whole project, without specific use or componentization.

    - **ğŸ“ infra/**

      These files open the server to the web. They're about infrastructure, like server:database communication (using `typeorm`) and routes & middlewares. It's here that the main `server.ts` file is located.

      - **ğŸ“ typeorm/**

        - **âœï¸ index.ts**

          Only opens connections with `typeorm`. Feeds on `ormconfig.json` from `root`.

        - **ğŸ“ migrations/**

          Every new change in database should be made using migrations to keep database integrity.

          To create a new migration, run `yarn typeorm migration:create -n name`, then edit file created inside this folder. The `name` has to be TitleCase and __very__ descriptive. Eg: `ChangeProviderFieldToProviderId`

          To run migrations and consolidate in server, run `yarn typeorm migration:run`

          To revert a migration, `yarn typeorm migration:revert`

    - **ğŸ“ errors/**

      - **âœï¸ AppError.ts**

        Handles errors through application instead of native JS error handler, making possible better error description.

    - **ğŸ“ container/**

      - **âœï¸ index.ts**

        Connects providers repositories with ORM using `tsyringe`.

      - **ğŸ“ providers/**

        Contains folders for providers. Important: the folders must be generic and not specific for service. Eg: instead of `Gmail Provider`, write a "Mail Provider` folder with the specific implementation (see below)

        - **âœï¸ index.ts**

          A simple file importing the providers.

        - **ğŸ“ <i>ServiceName</i>Provider/**

          This folder contains all information of the provider. This is an example for a fake service. For actual folders in this project, see next section.

          - **ğŸ“ dtos/**

            - **ğŸ›  I<i>DoSomething</i>DTO.ts**

              Stores typescript Data Transfer Objects.

          - **ğŸ“ fakes/**

            - **ğŸ§ª Fake<i>ServiceName</i>Provider.ts**

              A copy of the provider with fake data for testing. Can't rely on other components (as testing good practices)

          - **ğŸ“ implementations/**

              Stores all possible implementations of provider. Eg: `EtherealMail` and `SES`, or `Disk Storage` vs `S3`. Useful when changing provider or while developing locally.

              - **âœï¸ <i>ImplementationName</i>Provider.ts**

                Interacts with database (CRUD or other)

          - **ğŸ“ models/**

            - **ğŸ›  I<i>ModelName</i>Provider.ts**

              Store models and schemas for provider usage

          - **âœï¸ index.ts**

            Imports and connects providers with `tsyringe`

  - **ğŸ“ modules/**

    Here are the folders/files os specific relationships with the database. Repositories and Services should talk to the *ğŸ“ Providers* in *ğŸ“ Shared* folder.

    - **ğŸ“ _ModuleName_**

      The folder should have the associated module as its name. Eg: `users`, `notifications` or `appointments`.

      - **ğŸ“ dtos**

        - **ğŸ›  I<i>DoSomething</i>DTO.ts**

          Stores typescript Data Transfer Objects.

      - **ğŸ“ infra**

          Files related to module infrastructure

        - **ğŸ“ http**

          Code accessible by external sources, like API calls.

          - **ğŸ“ controllers**

            Controllers that interact with services.

            - **âœï¸ <i>ControllerName</i>Controller.ts**

              Each file has a class with limited functions. They never manipulate database directly, just call the associated services.

          - **ğŸ“ middlewares**

            Express middlewares for this specific module.

            - **âœï¸ <i>MiddlewareName</i>.ts**

              File that interacts with Express as a middleware, eg: ensureAuthenticate.ts

          - **ğŸ“ routes**

            Exposes routes to HTTP.

              - **âœˆï¸ <i>filename</i>.routes.ts**

                Uses Express to expose routes and work with middlewares.

        - **ğŸ“ typeorm**

          Stores files that interact with database

          - **ğŸ“ entities**

            These files are schemas or models using TypeScript @descriptors.

            - **âœï¸ <i>Filename</i>.ts**

          - **ğŸ“ repositories**

            Stores repositories that execute database queries and actions

            - **âœï¸ <i>FileName</i>Repository.ts**

              Find, create, update and delete from database

      - **ğŸ“ providers**

        Specific module providers

        - **ğŸ“ providers/**

          Different from the aforementioned `provider` folder, this one interacts directly with the module and needs it's existance to survive.

          - **âœï¸ index.ts**

            Imports and connects providers with `tsyringe`

          - **ğŸ“ <i>ServiceName</i>Provider/**

            Contains all information of the provider.

            - **ğŸ“ dtos/**

              - **ğŸ›  I<i>DoSomething</i>DTO.ts**

                Stores typescript Data Transfer Objects.

            - **ğŸ“ fakes/**

              - **ğŸ§ª Fake<i>ServiceName</i>Provider.ts**

                A copy of the provider with fake data for testing. Can't rely on other components (as testing good practices)

            - **ğŸ“ implementations/**

                Stores all possible implementations of provider. Eg: `BCryptHashProvider`.

                - **âœï¸ <i>ImplementationName</i>Provider.ts**

                  Interacts with database or service

            - **ğŸ“ models/**

              - **ğŸ›  I<i>ModelName</i>Provider.ts**

                Store models and schemas for provider usage

      - **ğŸ“ repositories**

        Stores fake and repository interface

        - **ğŸ“ fakes**

          Has fake repository for testing

          - **ğŸ§ª Fake<i>FileName</i>Repository.ts**

            Find, create, update and delete from local array, for testing purposes.

        - **ğŸ›  I<i>FileName</i>Repository.ts**

          Repository interface, typing all it's properties.

      - **ğŸ“ services**

        Stores services used by repositories, following Single Responsability Principle. Every file **has** to have it's test counterpart.

        - **âœï¸ <i>FileName</i>Service.ts**

          Has single property: `execute()`. It interacts with the request, formats and parses data, then responses accordingly.

        - **ğŸ§ª <i>FileName</i>Service.spec.ts**

          Tests service functionality using `jest`. Uses fake repositories and providers.

      - **ğŸ“ views**

        Stores possible views for module, like the handlebars file below for email-templating.

        - **âœï¸ <i>file_name</i>.hbs**

          Example file. This one is a handlebars file that serves as a template for the Mail service.

## Implementations

In this template, there are a few pre-made implementations.

- A Redis-based cache provider
- Two e-mail providers: Ethereal (development) and Amazon SES
- A e-mail template provider using handlebars
- Two storage providers: disk (dev and temporary storage) and Amazon S3

You can add/remove any of them knowing that you'll need to change other files, mainly those that connect the providers with the rest of the server... but that's easy if your IDE shows those kinds of "missing file" errors.

## Modules

In this template, there is a `user` module already implemented with the following services:

- Authenticate user (via JWT)
- Create user
- Reset password
- Send "forgot password" e-mail
- Show profile
- Update profile
- Update user avatar

## Root files walkthrough

- .gitignore: Ignores files and folders from git
- .env: It's imperative to have a `.env` file following `.env.example`. Fill the missing information before running server.
- .eslintignore: Ignores files and folders from eslint
- .eslintrc.json: Eslint configuration file
- babel.config.js: Babel configuration file
- jest.config.js: Jest configuration file
- ormconfig.json: Server Usage configuration file. Follow `ormconfig.example.json`.
- prettier.config.js: Prettier configuration file
- tsconfig.json: Typescript configuration file
- package.json: see below

## Package.json walkthrough

### Scripts

- `build`: parses typescript into `dist` folder
- `dev:server`: development server
- `start`: runs server
- `test`: runs `jest` tests
- `typeorm`: runs `typeorm` commands, like creating and running migrations

### Dependencies

- dotenv: loads `.env` files
- express: makes all the server _magic_ happen
- express-async-errors: async/await in express
- rate-limiter-flexible: protects the server from DDoS and brute force
- typeorm: ORM (object-relational mapping): language agnostic server communication
- uuidv4: generates unique ids

### Dev Dependencies

#### Babel & Typescript

- typescript: types!
- @babel/cli, core, env & node: Needed package for Babel transpile.
- @babel/preset-typescript: Preset for typescript usage
- @babel/plugin-proposal-class-decorators: Allows Typescript @decorators
- babel-plugin-transform-typescript-metadata: usage with decorators
- @babel/plugin-proposal-class-properties: Transforms static class properties as well as properties declared with the property initializer syntax. [Source](https://www.npmjs.com/package/@babel/plugin-proposal-class-properties)
- babel-plugin-module-resolver: best pathing, see [source](https://github.com/tleunen/babel-plugin-module-resolver)


#### Eslint

All below: configuration for `eslint` and `typescript`, using `airbnb` as base.

- eslint
- eslint-config-airbnb-base
- eslint-plugin-import
- eslint-import-resolver-typescript
- @typescript-eslint/eslint-plugin
- @typescript-eslint/parser

Working alongside `eslint` is `prettier`:

- prettier
- eslint-plugin-prettier
- eslint-config-prettier

#### Others

- jest: testing tool
- ts-jest: `jest` with `typescript`
- ts-node-dev: like `nodemon` but for `typescript` and `node`
- tsconfig-paths: best pathing (`paths` in `tsconfig`), eg `@module/file.ts` instead of `src/path/to/file/file.ts`

## SOLID

I've built this based on code from [Rocketseat](https://rocketseat.com.br/) bootcamp. I try the most to follow the [SOLID](https://khalilstemmler.com/articles/solid-principles/solid-typescript/) principles.

This Readme file is huge because I feel there's a lack of explanation and documentation on traditional Readmes, so, I decided to make one I'd really like to see lying around.

It took me about 8 hours to finish this project.

